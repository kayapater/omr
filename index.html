<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Optical Exam System - JavaScript Only</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        window._opencvLoadState = 'loading';

        function onOpenCvLoaded() {
            window._opencvLoadState = 'loaded';
            if (typeof window._initOpenCv === 'function') {
                window._initOpenCv();
            }
        }
        function onOpenCvError() {
            window._opencvLoadState = 'error';
            if (typeof window._showOpenCvError === 'function') {
                window._showOpenCvError();
            } else {
                var banner = document.getElementById('opencv-status');
                if (banner) {
                    banner.innerHTML = '<i class="fas fa-exclamation-triangle"></i> <span>OpenCV failed to load! Scanning will not work.</span>';
                    banner.className = 'opencv-loading-banner error';
                }
            }
            console.error('OpenCV.js failed to load');
        }
    </script>
    <script async src="https://docs.opencv.org/4.9.0/opencv.js" onload="onOpenCvLoaded()" onerror="onOpenCvError()" type="text/javascript"></script>
</head>
<body>
    <div class="app-container">
        <div id="opencv-status" class="opencv-loading-banner">
            <i class="fas fa-cog fa-spin"></i>
            <span>Loading OpenCV.js...</span>
        </div>

        <header class="app-header">
            <h1><i class="fas fa-graduation-cap"></i> Optical Exam System</h1>
            <p class="subtitle">Mobile OMR Scanning and Grading</p>
        </header>

        <nav class="main-nav">
            <button class="nav-btn active" data-page="home">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </button>
            <button class="nav-btn" data-page="create-exam">
                <i class="fas fa-plus-circle"></i>
                <span>Create Exam</span>
            </button>
            <button class="nav-btn" data-page="answer-keys">
                <i class="fas fa-key"></i>
                <span>Answer Key</span>
            </button>
            <button class="nav-btn" data-page="form-generator">
                <i class="fas fa-file-alt"></i>
                <span>Generate Form</span>
            </button>
            <button class="nav-btn" data-page="scan">
                <i class="fas fa-camera"></i>
                <span>Scan</span>
            </button>
            <button class="nav-btn" data-page="results">
                <i class="fas fa-chart-bar"></i>
                <span>Results</span>
            </button>
            <button class="nav-btn" data-page="account">
                <i class="fas fa-database"></i>
                <span>Data</span>
            </button>
        </nav>

        <main class="main-content">
            <section id="page-home" class="page active">
                <div class="welcome-card">
                    <h2><i class="fas fa-clipboard-list"></i> My Exams</h2>
                    <div id="exam-list" class="exam-list">
                        <div class="empty-state">
                            <i class="fas fa-folder-open"></i>
                            <p>No exams created yet</p>
                            <button class="btn btn-primary" onclick="navigateTo('create-exam')">
                                <i class="fas fa-plus"></i> Create Your First Exam
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <section id="page-create-exam" class="page">
                <div class="form-card">
                    <h2><i class="fas fa-edit"></i> Create New Exam</h2>
                    <form id="exam-form" class="exam-form">
                        <div class="form-group">
                            <label for="exam-name">
                                <i class="fas fa-tag"></i> Exam Name
                            </label>
                            <input type="text" id="exam-name" placeholder="E.g.: Math Midterm Exam" required>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="question-count">
                                    <i class="fas fa-list-ol"></i> Number of Questions
                                </label>
                                <input type="number" id="question-count" min="1" max="100" value="20" required>
                            </div>
                            <div class="form-group">
                                <label for="option-count">
                                    <i class="fas fa-check-circle"></i> Number of Options
                                </label>
                                <select id="option-count">
                                    <option value="2">2 (A-B)</option>
                                    <option value="3">3 (A-B-C)</option>
                                    <option value="4">4 (A-B-C-D)</option>
                                    <option value="5" selected>5 (A-B-C-D-E)</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="wrong-penalty">
                                    <i class="fas fa-minus-circle"></i> Wrong Penalty
                                </label>
                                <select id="wrong-penalty">
                                    <option value="0">None</option>
                                    <option value="2">2W = 1C</option>
                                    <option value="3">3W = 1C</option>
                                    <option value="4" selected>4W = 1C</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="points-per-question">
                                    <i class="fas fa-star"></i> Points Per Question
                                </label>
                                <input type="number" id="points-per-question" min="1" max="100" value="5" required>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="booklet-types">
                                <i class="fas fa-book"></i> Booklet Types
                            </label>
                            <div class="checkbox-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" name="booklet" value="A" checked> A
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="booklet" value="B"> B
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="booklet" value="C"> C
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="booklet" value="D"> D
                                </label>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary btn-block">
                            <i class="fas fa-save"></i> Save Exam
                        </button>
                    </form>
                </div>
            </section>

            <section id="page-answer-keys" class="page">
                <div class="welcome-card">
                    <h2><i class="fas fa-key"></i> Answer Keys</h2>
                    <div id="answer-keys-exam-list" class="exam-list">
                        <div class="empty-state">
                            <i class="fas fa-folder-open"></i>
                            <p>No exams created yet</p>
                            <button class="btn btn-primary" onclick="navigateTo('create-exam')">
                                <i class="fas fa-plus"></i> Create Exam
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <section id="page-answer-key" class="page">
                <div class="form-card">
                    <h2><i class="fas fa-key"></i> Answer Key</h2>
                    <div id="answer-key-exam-info" class="exam-info-banner"></div>
                    
                    <div id="booklet-tabs" class="booklet-tabs"></div>
                    <div id="answer-key-form" class="answer-key-form"></div>
                    
                    <div class="button-group">
                        <button id="save-answer-key" class="btn btn-primary btn-block">
                            <i class="fas fa-save"></i> Save Answer Key
                        </button>
                        <button id="generate-answer-sheet" class="btn btn-secondary btn-block" onclick="previewAnswerSheet()">
                            <i class="fas fa-file-image"></i> View Answer Sheet
                        </button>
                    </div>
                </div>
            </section>

            <section id="page-answer-sheet" class="page">
                <div class="form-card">
                    <h2><i class="fas fa-file-alt"></i> Answer Sheet</h2>
                    <div id="booklet-select-container" class="booklet-select-container">
                        <label for="preview-booklet">Booklet Type:</label>
                        <select id="preview-booklet"></select>
                    </div>
                    <div id="answer-sheet-preview" class="answer-sheet-preview">
                        <canvas id="answer-sheet-canvas"></canvas>
                    </div>
                    <div class="button-group">
                        <button id="download-answer-sheet" class="btn btn-primary btn-block">
                            <i class="fas fa-download"></i> Download as Image
                        </button>
                        <button id="print-answer-sheet" class="btn btn-secondary btn-block" onclick="window.print()">
                            <i class="fas fa-print"></i> Print
                        </button>
                    </div>
                </div>
            </section>

            <section id="page-form-generator" class="page">
                <div class="form-card">
                    <h2><i class="fas fa-file-alt"></i> Optical Form Generator</h2>
                    <p class="section-desc">
                        <i class="fas fa-info-circle"></i>
                        You can generate and download optical forms with your desired settings without creating an exam.
                    </p>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="fg-title">
                                <i class="fas fa-tag"></i> Form Title
                            </label>
                            <input type="text" id="fg-title" placeholder="E.g.: Practice Exam" value="Optical Form">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="fg-question-count">
                                <i class="fas fa-list-ol"></i> Number of Questions
                            </label>
                            <input type="number" id="fg-question-count" min="1" max="100" value="20">
                        </div>
                        <div class="form-group">
                            <label for="fg-option-count">
                                <i class="fas fa-check-circle"></i> Number of Options
                            </label>
                            <select id="fg-option-count">
                                <option value="2">2 (A-B)</option>
                                <option value="3">3 (A-B-C)</option>
                                <option value="4">4 (A-B-C-D)</option>
                                <option value="5" selected>5 (A-B-C-D-E)</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="fg-booklet">
                                <i class="fas fa-book"></i> Booklet Type
                            </label>
                            <select id="fg-booklet">
                                <option value="">Not Selected (Blank)</option>
                                <option value="A">Booklet A</option>
                                <option value="B">Booklet B</option>
                                <option value="C">Booklet C</option>
                                <option value="D">Booklet D</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="fg-copies">
                                <i class="fas fa-copy"></i> Number of Copies
                            </label>
                            <input type="number" id="fg-copies" min="1" max="20" value="1">
                        </div>
                    </div>

                    <button class="btn btn-primary btn-block" onclick="generateStandaloneForm()">
                        <i class="fas fa-magic"></i> Generate Form
                    </button>

                    <div id="fg-preview-area" class="fg-preview-area hidden">
                        <h3><i class="fas fa-eye"></i> Preview</h3>
                        <div class="fg-canvas-wrapper">
                            <canvas id="fg-canvas"></canvas>
                        </div>
                        <div class="button-group">
                            <button class="btn btn-primary btn-block" onclick="downloadStandaloneForm()">
                                <i class="fas fa-download"></i> Download as Image
                            </button>
                            <button class="btn btn-secondary btn-block" onclick="printStandaloneForm()">
                                <i class="fas fa-print"></i> Print
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <section id="page-scan" class="page">
                <div class="scan-card">
                    <h2><i class="fas fa-camera"></i> OMR Scanner</h2>
                    
                    <div id="scan-mode-select" class="scan-mode-select">
                        <div class="form-group">
                            <label for="manual-exam-select">Select Exam:</label>
                            <select id="manual-exam-select">
                                <option value="">-- Select Exam --</option>
                            </select>
                        </div>
                        <div class="scan-buttons-row">
                            <button class="btn btn-primary" id="manual-scan-btn" disabled onclick="startOpticalScanner()">
                                <i class="fas fa-camera"></i> Scan with Camera
                            </button>
                            <button class="btn btn-secondary" id="file-scan-btn" disabled onclick="startFileScan()">
                                <i class="fas fa-file-image"></i> Upload from File
                            </button>
                        </div>
                        <input type="file" id="scan-file-input" accept="image/*" class="hidden" onchange="handleFileSelected(event)">
                        <p class="scan-hint">
                            <i class="fas fa-info-circle"></i>
                            You can scan live with the camera or upload a previously taken photo from a file.
                            Make sure the black square markers at the 4 corners are visible.
                        </p>

                        <div id="file-preview-container" class="file-preview-container hidden">
                            <h4><i class="fas fa-image"></i> Uploaded Image</h4>
                            <img id="file-preview-image" class="file-preview-image" />
                            <canvas id="file-scan-canvas" class="hidden"></canvas>
                            <div class="button-group">
                                <button class="btn btn-primary btn-block" onclick="processFileImage()">
                                    <i class="fas fa-search"></i> Read Form
                                </button>
                                <button class="btn btn-secondary btn-block" onclick="cancelFileScan()">
                                    <i class="fas fa-times"></i> Cancel
                                </button>
                            </div>
                        </div>
                    </div>

                    <div id="optical-scanner-container" class="scanner-container hidden">
                        <div class="scanner-header">
                            <span id="current-exam-name"></span>
                            <button class="btn btn-sm btn-danger" onclick="stopOpticalScanner()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <video id="optical-video" autoplay playsinline></video>
                        <canvas id="optical-canvas" class="hidden"></canvas>
                        <canvas id="marker-overlay-canvas" class="marker-overlay"></canvas>
                        <div class="scanner-guide">
                            <div class="corner-guide top-left"></div>
                            <div class="corner-guide top-right"></div>
                            <div class="corner-guide bottom-left"></div>
                            <div class="corner-guide bottom-right"></div>
                        </div>
                        <div class="scanner-controls">
                            <button class="btn btn-primary capture-btn" onclick="captureAndProcess()">
                                <i class="fas fa-camera"></i> Capture and Grade
                            </button>
                        </div>
                        <div id="detection-status" class="detection-status">
                            <span class="status-icon"><i class="fas fa-search"></i></span>
                            <span class="status-text">Searching for form...</span>
                        </div>
                    </div>

                    <div id="scan-result" class="scan-result hidden">
                        <h3><i class="fas fa-check-circle"></i> Scan Result</h3>
                        
                        <div id="debug-preview-container" class="debug-preview-container hidden">
                            <canvas id="debug-canvas" class="debug-canvas"></canvas>
                            <button class="btn btn-sm btn-secondary" onclick="toggleDebugPreview()">
                                <i class="fas fa-eye"></i> Hide Debug Image
                            </button>
                        </div>

                        <div class="result-details">
                            <div class="result-item">
                                <span class="label">Student Code:</span>
                                <input type="text" id="result-student-code" class="result-edit-input" maxlength="10">
                            </div>
                            <div class="result-item">
                                <span class="label">Booklet:</span>
                                <select id="result-booklet" class="result-edit-select"></select>
                            </div>
                            <div class="result-stats">
                                <div class="stat correct">
                                    <i class="fas fa-check"></i>
                                    <span id="result-correct">0</span>
                                    <small>Correct</small>
                                </div>
                                <div class="stat wrong">
                                    <i class="fas fa-times"></i>
                                    <span id="result-wrong">0</span>
                                    <small>Wrong</small>
                                </div>
                                <div class="stat empty">
                                    <i class="fas fa-minus"></i>
                                    <span id="result-empty">0</span>
                                    <small>Blank</small>
                                </div>
                            </div>
                            <div class="result-summary">
                                <div class="summary-item">
                                    <span class="label">Net Score:</span>
                                    <span id="result-net" class="value highlight">0</span>
                                </div>
                                <div class="summary-item">
                                    <span class="label">Score:</span>
                                    <span id="result-score" class="value highlight">0</span>
                                </div>
                            </div>
                        </div>
                        <div id="flagged-questions" class="flagged-questions hidden">
                            <h4><i class="fas fa-exclamation-triangle"></i> Flagged Questions</h4>
                            <div id="flagged-list"></div>
                        </div>

                        <div class="button-group">
                            <button class="btn btn-primary" onclick="saveResult()">
                                <i class="fas fa-save"></i> Save
                            </button>
                            <div id="after-save-actions" class="after-save-actions hidden">
                                <span class="after-save-label">Next action:</span>
                                <div class="after-save-buttons">
                                    <button class="btn btn-accent" onclick="continueWithCamera()">
                                        <i class="fas fa-camera"></i> Scan with Camera
                                    </button>
                                    <button class="btn btn-secondary" onclick="continueWithFile()">
                                        <i class="fas fa-file-image"></i> Scan from File
                                    </button>
                                    <button class="btn btn-danger-outline" onclick="finishScanning()">
                                        <i class="fas fa-stop-circle"></i> Finish
                                    </button>
                                </div>
                            </div>
                            <button class="btn btn-secondary" onclick="rescan()">
                                <i class="fas fa-redo"></i> Rescan
                            </button>
                            <button class="btn btn-info btn-sm" onclick="toggleDebugPreview()">
                                <i class="fas fa-bug"></i> Debug Image
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <section id="page-results" class="page">
                <div class="results-card">
                    <h2><i class="fas fa-chart-bar"></i> Exam Results</h2>
                    
                    <div class="form-group">
                        <label for="results-exam-select">Select Exam:</label>
                        <select id="results-exam-select">
                            <option value="">-- Select Exam --</option>
                        </select>
                    </div>

                    <div id="results-summary" class="results-summary hidden">
                        <div class="summary-stats">
                            <div class="stat-box">
                                <i class="fas fa-users"></i>
                                <span id="total-students">0</span>
                                <small>Students</small>
                            </div>
                            <div class="stat-box">
                                <i class="fas fa-chart-line"></i>
                                <span id="avg-score">0</span>
                                <small>Average</small>
                            </div>
                            <div class="stat-box">
                                <i class="fas fa-arrow-up"></i>
                                <span id="max-score">0</span>
                                <small>Highest</small>
                            </div>
                            <div class="stat-box">
                                <i class="fas fa-arrow-down"></i>
                                <span id="min-score">0</span>
                                <small>Lowest</small>
                            </div>
                        </div>
                    </div>

                    <div id="results-table-container" class="results-table-container">
                        <table id="results-table" class="results-table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Code</th>
                                    <th>Booklet</th>
                                    <th>C</th>
                                    <th>W</th>
                                    <th>B</th>
                                    <th>Net</th>
                                    <th>Score</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="results-tbody">
                            </tbody>
                        </table>
                        <div id="no-results" class="empty-state">
                            <i class="fas fa-inbox"></i>
                            <p>No results recorded yet</p>
                        </div>
                    </div>

                    <div class="button-group">
                        <button id="export-csv" class="btn btn-primary" disabled>
                            <i class="fas fa-file-csv"></i> Download CSV
                        </button>
                        <button id="export-json-results" class="btn btn-secondary" disabled>
                            <i class="fas fa-file-code"></i> Download JSON
                        </button>
                    </div>
                </div>
            </section>

            <section id="page-account" class="page">
                <div class="form-card">
                    <h2><i class="fas fa-database"></i> Data Management</h2>
                    <p style="font-size: 0.9rem; color: var(--gray-600); margin-bottom: 16px;">
                        <i class="fas fa-info-circle"></i>
                        All your data is stored on this device. You can export your data or restore from a backup.
                    </p>

                    <div id="account-logged-out" class="account-section">
                        <div class="button-group">
                            <button class="btn btn-success btn-block" onclick="exportAllData()">
                                <i class="fas fa-download"></i> Download All Data (JSON)
                            </button>
                            <button class="btn btn-info btn-block" onclick="importDataFromFile()">
                                <i class="fas fa-upload"></i> Import Data
                            </button>
                            <button class="btn btn-warning btn-block" onclick="clearAllData()">
                                <i class="fas fa-trash"></i> Delete All Data
                            </button>
                        </div>

                        <hr style="margin: 20px 0; border: none; border-top: 1px solid var(--gray-300);">

                        <div style="padding: 16px; background: var(--gray-100); border-radius: var(--radius-md); font-size: 0.85rem;">
                            <strong>Storage Statistics:</strong>
                            <div id="storage-stats" style="margin-top: 10px;">
                                <div style="display: flex; justify-content: space-between; margin: 4px 0;">
                                    <span>Exams:</span>
                                    <strong><span id="stat-exams">0</span></strong>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin: 4px 0;">
                                    <span>Results:</span>
                                    <strong><span id="stat-results">0</span></strong>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin: 4px 0;">
                                    <span>Storage Used:</span>
                                    <strong><span id="stat-storage">0</span> MB</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <div id="toast" class="toast"></div>

        <div id="loading" class="loading-overlay hidden">
            <div class="spinner"></div>
            <p>Processing...</p>
        </div>

        <div id="modal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="modal-title"></h3>
                    <button class="modal-close" onclick="closeModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div id="modal-body" class="modal-body"></div>
                <div id="modal-footer" class="modal-footer"></div>
            </div>
        </div>
    </div>

    <script src="storage.js"></script>
    <script src="form-template.js"></script>
    <script src="omr-processor.js"></script>
    <script src="app.js"></script>
</body>
</html>
